name: Refresh All Experiments

on:
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  refresh-experiments:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Refresh all experiments
        id: refresh-experiments
        env:
          AWS_BEARER_TOKEN_BEDROCK: ${{ secrets.AWS_BEARER_TOKEN_BEDROCK }}
        run: |
          python -m src.cli update-all
          # The script will exit with code 1 if any experiment fails, causing the workflow to fail
      
      - name: Generate minified dashboard data
        if: success()
        run: |
          python scripts/generate_dashboard_data.py docs/results docs/results/dashboard_data.json
      
      - name: Commit and push results
        if: success()
        run: |
          # Safe pull with retry logic
          safe_pull() {
            local max_attempts=5
            local attempt=1
            while [ $attempt -le $max_attempts ]; do
              # Stash any untracked files in docs/results/ before pulling
              git stash push -u -m "Stash untracked results before pull" -- docs/results/ || true
              
              if git pull --rebase origin main || git pull origin main; then
                # Restore stashed files
                git stash pop || true
                return 0
              fi
              
              # Restore stashed files before retry
              git stash pop || true
              
              echo "Pull attempt $attempt failed, retrying..."
              sleep $((2 ** attempt))
              attempt=$((attempt + 1))
            done
            return 1
          }
          
          safe_pull
          
          # Ensure dashboard data is regenerated (in case it wasn't in the previous step)
          python scripts/generate_dashboard_data.py docs/results docs/results/dashboard_data.json
          
          # Add all result files - explicitly include dashboard_data.json
          git add docs/results/
          git add docs/results/dashboard_data.json
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Refresh experiments: update all experiments with changed/new tasks"
            
            # Push with retry logic
            max_attempts=5
            attempt=1
            while [ $attempt -le $max_attempts ]; do
              if git push origin main; then
                echo "Successfully pushed changes"
                break
              else
                echo "Push attempt $attempt failed, retrying..."
                if [ $attempt -lt $max_attempts ]; then
                  sleep $((2 ** attempt))
                  safe_pull
                  attempt=$((attempt + 1))
                else
                  echo "Failed to push after $max_attempts attempts"
                  exit 1
                fi
              fi
            done
          fi

